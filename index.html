<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Microsoft Credentials Dashboard (static)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; margin:0; background:#f6f8fa; color:#111; }
    header{background:#0078d4;color:#fff;padding:1rem}
    .container{max-width:900px;margin:1rem auto;padding:1rem;background:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .small{font-size:.9rem;color:#555}
    ul{list-style:none;padding:0;margin:0}
    li{padding:.75rem 1rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .time{color:#666;font-size:.9rem}
    .meta{margin-bottom:1rem;color:#444}
    .error{color:#b00020}
    .controls{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem}
    .subscribe{margin-top:1rem;padding:1rem;border:1px solid #eee;border-radius:6px}
    input[type="email"]{padding:.5rem;width:280px}
    button{padding:.5rem 1rem;border-radius:6px;border:none;background:#0078d4;color:#fff;cursor:pointer}
    pre { background:#f3f4f6;padding:.5rem;border-radius:6px;overflow:auto;max-height:200px }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0">Microsoft Credentials Dashboard</h1>
    <div style="opacity:.9;margin-top:6px">Live updates when new certifications, exams or skills appear (static)</div>
  </header>

  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <h2 style="margin:0">Credentials</h2>
      <small id="status" class="time">Loading…</small>
    </div>

    <div id="meta" class="meta">Loading status…</div>

    <div class="controls">
      <div>
        <label><input type="checkbox" id="filter-cert" checked> Certifications</label>
        <label style="margin-left:8px"><input type="checkbox" id="filter-exam" checked> Exams</label>
        <label style="margin-left:8px"><input type="checkbox" id="filter-skill" checked> Skills</label>
      </div>
      <div class="small">Filter the list by type.</div>
    </div>

    <ul id="list"><li>Loading…</li></ul>

    <div style="margin-top:16px">
      <h4>Debug / Control</h4>
      <div class="small">If the dashboard is empty, click the button to re-fetch credentials.json from the repository (credentials.json is updated by the GitHub Action).</div>
      <div style="margin-top:8px">
        <button id="btn-refresh">Refresh from credentials.json</button>
      </div>
      <div id="debug-output" style="margin-top:12px"></div>
    </div>

    <div style="margin-top:18px">
      <h4>Subscriptions/Emails</h4>
      <p class="small">Note: this static deployment does not support email subscriptions (those require a backend). If you want subscription emails, I recommend deploying the Node backend to Replit/Render/Railway (I can give a simple guide) or using a 3rd-party service for form submissions.</p>
    </div>
  </div>

  <script>
    const listEl = document.getElementById('list');
    const metaEl = document.getElementById('meta');
    const status = document.getElementById('status');
    const debugOut = document.getElementById('debug-output');

    const filterCert = document.getElementById('filter-cert');
    const filterExam = document.getElementById('filter-exam');
    const filterSkill = document.getElementById('filter-skill');

    let allItems = [];

    function render(items) {
      listEl.innerHTML = '';
      if (!items || items.length === 0) { listEl.innerHTML = '<li>No credentials found.</li>'; return; }
      for (const it of items) {
        const li = document.createElement('li');
        const a = document.createElement('a'); a.href = it.url; a.target = '_blank'; a.rel='noopener noreferrer'; a.textContent = it.title;
        const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
        const type = document.createElement('div'); type.className='small'; type.textContent = it.type;
        const time = document.createElement('div'); time.className='time'; time.textContent = it.id ? '' : '';
        right.appendChild(type); right.appendChild(time);
        li.appendChild(a); li.appendChild(right);
        listEl.appendChild(li);
      }
    }

    function applyFilters() {
      const showCert = filterCert.checked, showExam = filterExam.checked, showSkill = filterSkill.checked;
      const filtered = allItems.filter(it => {
        if (it.type === 'certification') return showCert;
        if (it.type === 'exam') return showExam;
        if (it.type === 'skill') return showSkill;
        return true;
      });
      render(filtered);
    }

    async function loadCredentials() {
      status.textContent = 'Loading…';
      debugOut.innerHTML = '';
      try {
        const res = await fetch('./credentials.json', { cache: 'no-store' });
        if (!res.ok) {
          const txt = await res.text();
          metaEl.textContent = 'Error loading credentials.json: ' + res.status + ' ' + txt;
          status.textContent = 'Error';
          listEl.innerHTML = '<li>Error loading data</li>';
          return;
        }
        const j = await res.json();
        allItems = j.items || [];
        applyFilters();
        metaEl.textContent = `Generated: ${j.generated_at || 'n/a'} | Source: ${j.source || 'n/a'} | Items: ${allItems.length}`;
        status.textContent = 'Loaded';
      } catch (err) {
        metaEl.textContent = 'Fetch error: ' + (err.message || err);
        status.textContent = 'Error';
        listEl.innerHTML = '<li>Error loading data</li>';
      }
    }

    document.getElementById('btn-refresh').addEventListener('click', async () => {
      debugOut.innerHTML = '<div class="small">Fetching ./credentials.json ...</div>';
      await loadCredentials();
      debugOut.innerHTML = '<div class="small">Done. See status above.</div>';
    });

    filterCert.addEventListener('change', applyFilters);
    filterExam.addEventListener('change', applyFilters);
    filterSkill.addEventListener('change', applyFilters);

    // initial load
    loadCredentials();
  </script>
</body>
</html>
