<!-- public/index.html
     Updated frontend: shows detailed errors and explicit socket connection to current origin.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Microsoft Credentials Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; margin:0; background:#f6f8fa; color:#111; }
    header{background:#0078d4;color:#fff;padding:1rem}
    .container{max-width:900px;margin:1rem auto;padding:1rem;background:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .small{font-size:.9rem;color:#555}
    ul{list-style:none;padding:0;margin:0}
    li{padding:.75rem 1rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .time{color:#666;font-size:.9rem}
    .meta{margin-bottom:1rem;color:#444}
    .error{color:#b00020}
    .success{color:#0b8457}
    .controls{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem}
    .subscribe{margin-top:1rem;padding:1rem;border:1px solid #eee;border-radius:6px}
    input[type="email"]{padding:.5rem;width:280px}
    button{padding:.5rem 1rem;border-radius:6px;border:none;background:#0078d4;color:#fff;cursor:pointer}
    .inline{display:inline-block;margin-left:8px}
    #statusBox{position:fixed;right:1rem;top:6rem;background:#fff;padding:.5rem 1rem;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12)}
    pre { background:#f3f4f6;padding:.5rem;border-radius:6px;overflow:auto;max-height:200px }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0">Microsoft Credentials Dashboard</h1>
    <div style="opacity:.9;margin-top:6px">Live updates when new certifications, exams or skills appear</div>
  </header>

  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <h2 style="margin:0">Credentials</h2>
      <small id="status" class="time">Connecting...</small>
    </div>

    <div id="meta" class="meta">Loading status…</div>

    <div class="controls">
      <div>
        <label><input type="checkbox" id="filter-cert" checked> Certifications</label>
        <label style="margin-left:8px"><input type="checkbox" id="filter-exam" checked> Exams</label>
        <label style="margin-left:8px"><input type="checkbox" id="filter-skill" checked> Skills</label>
      </div>
      <div class="small">Filter the list by type. New items matching filters will appear live.</div>
    </div>

    <ul id="list"><li>Loading…</li></ul>

    <div class="subscribe">
      <h3 style="margin-top:0">Subscribe for email notifications</h3>
      <div class="small">Enter your email and choose which types you'd like to get notifications for. You will receive a confirmation email and must confirm before receiving notifications.</div>

      <form id="subscribe-form" style="margin-top:8px">
        <div style="margin:8px 0"><input id="sub-email" type="email" placeholder="you@example.com" required></div>
        <div>
          <label><input type="checkbox" id="sub-cert" checked> Certifications</label>
          <label style="margin-left:8px"><input type="checkbox" id="sub-exam"> Exams</label>
          <label style="margin-left:8px"><input type="checkbox" id="sub-skill"> Skills</label>
        </div>
        <div style="margin-top:8px"><button id="sub-submit" type="submit">Subscribe</button> <span id="sub-msg"></span></div>
      </form>

      <hr style="margin:12px 0">

      <h4 style="margin:0 0 8px 0">Have a pending confirmation?</h4>
      <div class="small">If you didn't receive the confirmation email, enter your email below to resend it.</div>

      <form id="resend-form" style="margin-top:8px">
        <input id="resend-email" type="email" placeholder="you@example.com" required>
        <button id="resend-submit" class="inline" type="submit">Resend confirmation</button>
        <span id="resend-msg" style="margin-left:12px"></span>
      </form>

      <hr style="margin:12px 0">

      <h4 style="margin:0 0 8px 0">Want to unsubscribe?</h4>
      <div class="small">If you want to unsubscribe but don't have your unsubscribe link, request an unsubscribe email.</div>

      <form id="req-unsub-form" style="margin-top:8px">
        <input id="req-unsub-email" type="email" placeholder="you@example.com" required>
        <button id="req-unsub-submit" class="inline" type="submit">Request unsubscribe email</button>
        <span id="req-unsub-msg" style="margin-left:12px"></span>
      </form>
    </div>

    <div style="margin-top:16px">
      <h4>Debug</h4>
      <div class="small">If the dashboard is not loading, click the buttons below and paste the results into the chat so I can diagnose faster.</div>
      <div style="margin-top:8px">
        <button id="btn-check-credentials">Fetch /api/credentials now</button>
        <button id="btn-debug-fetch">Fetch /api/debug-fetch</button>
      </div>
      <div id="debug-output" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="statusBox">Socket status: <span id="socketStatus">—</span></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // UI elements
    const statusEl = document.getElementById('status');
    const socketStatus = document.getElementById('socketStatus');
    const metaEl = document.getElementById('meta');
    const listEl = document.getElementById('list');
    const debugOut = document.getElementById('debug-output');

    const filterCert = document.getElementById('filter-cert');
    const filterExam = document.getElementById('filter-exam');
    const filterSkill = document.getElementById('filter-skill');

    let allItems = [];

    function setMeta(text) { metaEl.textContent = text; }
    function setSocketStatus(text, isError=false) { socketStatus.textContent = text; if (isError) socketStatus.style.color = 'red'; else socketStatus.style.color = 'green'; }
    function setList(items) {
      listEl.innerHTML = '';
      if (!items || items.length === 0) { listEl.innerHTML = '<li>No credentials found.</li>'; return; }
      for (const it of items) {
        const li = document.createElement('li');
        const a = document.createElement('a'); a.href = it.url; a.target = '_blank'; a.rel='noopener noreferrer'; a.textContent = it.title;
        const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
        const type = document.createElement('div'); type.className='small'; type.textContent = it.type;
        const time = document.createElement('div'); time.className='time'; time.textContent = new Date(it.first_seen_at).toLocaleString();
        right.appendChild(type); right.appendChild(time);
        li.appendChild(a); li.appendChild(right);
        listEl.appendChild(li);
      }
    }

    function applyFilters() {
      const showCert = filterCert.checked, showExam = filterExam.checked, showSkill = filterSkill.checked;
      const filtered = allItems.filter(it => {
        if (it.type === 'certification') return showCert;
        if (it.type === 'exam') return showExam;
        if (it.type === 'skill') return showSkill;
        return true;
      });
      setList(filtered);
    }

    // Load credentials + status
    async function loadInitial() {
      try {
        const res = await fetch('/api/credentials');
        if (!res.ok) {
          const txt = await res.text();
          setList([]);
          setMeta('Error loading data (status ' + res.status + '): ' + txt);
          return;
        }
        const json = await res.json();
        allItems = json.data || [];
        applyFilters();
      } catch (err) {
        console.error('Error calling /api/credentials', err);
        setList([]);
        setMeta('Error loading data: ' + (err.message || err));
      }
      // load status
      try {
        const s = await fetch('/api/status').then(r => r.json());
        let m = `Last scrape: ${s.last_scrape || 'n/a'} | Started: ${s.last_scrape_started || 'n/a'} | New items last run: ${s.last_new_count || 0} | Total items: ${s.total || 0}`;
        if (s.last_error) m += ' | Error: ' + s.last_error;
        setMeta(m);
      } catch (err) { console.warn('Could not load /api/status', err); }
    }

    filterCert.addEventListener('change', applyFilters);
    filterExam.addEventListener('change', applyFilters);
    filterSkill.addEventListener('change', applyFilters);

    loadInitial();

    // Socket.IO: explicitly connect to current origin (helps behind proxies).
    const socket = io(window.location.origin, { transports: ['websocket', 'polling'] });

    socket.on('connect', () => { statusEl.textContent = 'Connected'; setSocketStatus('connected'); });
    socket.on('disconnect', (reason) => { statusEl.textContent = 'Disconnected (' + reason + ')'; setSocketStatus('disconnected', true); });
    socket.on('connect_error', (err) => { console.error('Socket connect_error', err); setSocketStatus('connect_error', true); statusEl.textContent = 'Socket connect error'; });
    socket.on('new-credential', (data) => {
      allItems.unshift(data);
      applyFilters();
      loadInitial(); // refresh status too
    });

    // Forms
    document.getElementById('subscribe-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('sub-email').value.trim();
      const types = [];
      if (document.getElementById('sub-cert').checked) types.push('certification');
      if (document.getElementById('sub-exam').checked) types.push('exam');
      if (document.getElementById('sub-skill').checked) types.push('skill');
      const msgEl = document.getElementById('sub-msg');
      msgEl.textContent = '';
      try {
        const res = await fetch('/api/subscribe', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, types }) });
        const j = await res.json();
        if (res.ok) { msgEl.textContent = j.message || 'Subscribed — check your email'; msgEl.className = 'success'; }
        else { msgEl.textContent = j.error || 'Subscription failed'; msgEl.className='error'; }
      } catch (err) { console.error(err); msgEl.textContent = 'Error subscribing'; msgEl.className='error'; }
    });

    document.getElementById('resend-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('resend-email').value.trim();
      const out = document.getElementById('resend-msg'); out.textContent='';
      try {
        const res = await fetch('/api/resend-confirmation', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email }) });
        const j = await res.json();
        if (res.ok) { out.textContent = j.message || 'Confirmation resent'; out.className='success'; }
        else { out.textContent = j.error || 'Resend failed'; out.className='error'; }
      } catch (err) { console.error(err); out.textContent='Error'; out.className='error'; }
    });

    document.getElementById('req-unsub-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('req-unsub-email').value.trim();
      const out = document.getElementById('req-unsub-msg'); out.textContent='';
      try {
        const res = await fetch('/api/request-unsubscribe', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ email }) });
        const j = await res.json();
        if (res.ok) { out.textContent = j.message || 'Unsubscribe email sent'; out.className='success'; }
        else { out.textContent = j.error || 'Request failed'; out.className='error'; }
      } catch (err) { console.error(err); out.textContent='Error'; out.className='error'; }
    });

    // Debug buttons
    document.getElementById('btn-check-credentials').addEventListener('click', async () => {
      debugOut.innerHTML = '<div class="small">Fetching /api/credentials...</div>';
      try {
        const res = await fetch('/api/credentials');
        const text = await res.text();
        debugOut.innerHTML = `<pre>${res.status} ${res.statusText}\n\n${escapeHtml(text)}</pre>`;
      } catch (err) { debugOut.innerHTML = `<div class="error">Network error: ${err.message || err}</div>`; console.error(err); }
    });
    document.getElementById('btn-debug-fetch').addEventListener('click', async () => {
      debugOut.innerHTML = '<div class="small">Fetching /api/debug-fetch...</div>';
      try {
        const res = await fetch('/api/debug-fetch'); const j = await res.json();
        debugOut.innerHTML = `<pre>${escapeHtml(JSON.stringify(j, null, 2))}</pre>`;
      } catch (err) { debugOut.innerHTML = `<div class="error">Network error: ${err.message || err}</div>`; console.error(err); }
    });

    function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  </script>
</body>
</html>
